<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./CSS/cadastroaluno.css">
    <title>Gerenciar Alunos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
      <link rel="icon" href="Img/favicon.ico" />
  <link rel="apple-touch-icon" href="./Img/icon-192.png">
    <style>
        .nav-buttons {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 1000;
        }
        
        .nav-btn {
            background: white;
            color: #1A1A22;
            border: 2px solid #e5e7eb;
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #F28C2E;
        }
        
        .nav-btn-primary {
            background: #F28C2E;
            color: white;
            border-color: #F28C2E;
        }
        
        .nav-btn-primary:hover {
            background: #d97b26;
            border-color: #d97b26;
        }

        /* Busca do aluno */
        .busca-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .busca-wrapper {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .busca-wrapper input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .busca-wrapper input:focus {
            outline: none;
            border-color: #F28C2E;
        }

        .busca-wrapper button {
            padding: 0.8rem 1.5rem;
            background: #F28C2E;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .busca-wrapper button:hover {
            background: #d97b26;
            transform: translateY(-2px);
        }

        /* Perfil Header */
        .perfil-header {
            display: flex;
            gap: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            margin-bottom: 2rem;
            align-items: center;
        }

        .foto-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .foto-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #F28C2E;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-foto {
            padding: 0.6rem 1.2rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-foto:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .info-basica {
            flex: 1;
        }

        .info-basica h2 {
            color: #1A1A22;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .badge.ativo {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.inativo {
            background: #fee2e2;
            color: #991b1b;
        }

        .info-basica p {
            margin: 0.3rem 0;
            color: #6b7280;
        }

        .info-basica strong {
            color: #374151;
        }

        /* Senha Box */
        .senha-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
        }

        .senha-box strong {
            color: #92400e;
            font-size: 1rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .senha-valor {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1A1A22;
            margin: 0.8rem 0;
            letter-spacing: 2px;
        }

        .senha-box small {
            color: #92400e;
            display: block;
            margin-top: 0.5rem;
            line-height: 1.5;
        }

        /* Bot√µes de a√ß√£o */
        .acoes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-action {
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-salvar {
            background: #10b981;
            color: white;
        }

        .btn-salvar:hover {
            background: #059669;
        }

        .btn-resetar {
            background: #f59e0b;
            color: white;
        }

        .btn-resetar:hover {
            background: #d97706;
        }

        .btn-desativar {
            background: #ef4444;
            color: white;
        }

        .btn-desativar:hover {
            background: #dc2626;
        }

        .btn-ativar {
            background: #10b981;
            color: white;
        }

        .btn-ativar:hover {
            background: #059669;
        }

        .btn-copiar {
            background: #6b7280;
            color: white;
        }

        .btn-copiar:hover {
            background: #4b5563;
        }

        /* Loading e Resultado */
        #loading {
            text-align: center;
            padding: 3rem;
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #loading.show {
            display: block;
        }

        #loading p {
            font-size: 1.1rem;
            color: #6b7280;
            margin-top: 1rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #F28C2E;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #resultado {
            display: none;
        }

        #resultado.show {
            display: block;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .nav-buttons {
                position: static;
                justify-content: center;
                margin: 1rem;
            }
            
            .nav-btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }

            .perfil-header {
                flex-direction: column;
                text-align: center;
            }

            .acoes {
                grid-template-columns: 1fr;
            }

            .busca-wrapper {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <main>
        <div class="nav-buttons">
            <button class="nav-btn nav-btn-primary" onclick="window.location.href='./cadastroaluno.html'">
                ‚ûï Cadastrar Aluno
            </button>
            <button class="nav-btn" onclick="window.location.href='./lider.html'">
                ‚Ü©Ô∏è Voltar
            </button>
        </div>
        
        <div class="header">
            <div class="header-content">
                <h1>Gerenciar Alunos</h1>
                <p>Sistema de Gest√£o</p>
            </div>
        </div>
        
        <div class="content">
            <div class="info-box">
                <div>
                    <h3>Informa√ß√µes sobre o gerenciamento</h3>
                    <p>
                        ‚Ä¢ Digite o email do aluno para buscar e editar suas informa√ß√µes<br>
                        ‚Ä¢ Voc√™ pode alterar dados pessoais, profissionais e a foto do aluno<br>
                        ‚Ä¢ Use "Resetar Senha" para enviar email de redefini√ß√£o ao aluno<br>
                        ‚Ä¢ A senha exibida √© a senha tempor√°ria original do cadastro
                    </p>
                </div>
            </div>

            <div class="busca-section">
                <h3 style="color: #1A1A22; margin-bottom: 0.5rem;">üîç Buscar Aluno</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                    Digite o email do aluno que deseja gerenciar
                </p>
                <div class="busca-wrapper">
                    <input 
                        type="email" 
                        id="emailBusca" 
                        placeholder="exemplo@email.com"
                        onkeypress="if(event.key==='Enter') buscarAluno()"
                    >
                    <button onclick="buscarAluno()">üîç Buscar</button>
                </div>
            </div>
            
            <div id="loading">
                <div class="spinner"></div>
                <p>‚è≥ Buscando aluno...</p>
            </div>
            
            <div id="resultado">
                <!-- Perfil do aluno -->
                <div class="perfil-header">
                    <div class="foto-section">
                        <img id="fotoPreview" class="foto-preview" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Foto do aluno">
                        <input type="file" id="fotoInput" accept="image/*" style="display: none;" onchange="handleFotoChange(event)">
                        <button class="btn-foto" onclick="document.getElementById('fotoInput').click()">
                            üì∏ Alterar Foto
                        </button>
                    </div>
                    <div class="info-basica">
                        <h2 id="alunoNomeDisplay"></h2>
                        <span id="statusBadge" class="badge ativo">‚óè Ativo</span>
                        <p><strong>Email:</strong> <span id="alunoEmailDisplay"></span></p>
                        <p><strong>ID:</strong> <span id="alunoIdDisplay"></span></p>
                    </div>
                </div>

                <!-- Formul√°rio de edi√ß√£o -->
                <form id="formEdicao" onsubmit="salvarAlteracoes(event)">
                    <div class="form-section">
                        <div class="section-title">Informa√ß√µes Pessoais</div>
                        
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="editNome">
                                    Nome Completo <span class="required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="editNome" 
                                    required
                                    placeholder="Nome completo do aluno"
                                >
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="editNomeExibicao">
                                    Nome de Exibi√ß√£o <span class="required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="editNomeExibicao" 
                                    required
                                    placeholder="Nome que aparece na interface"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="editEmail">
                                    Email <span class="required">*</span>
                                </label>
                                <input 
                                    type="email" 
                                    id="editEmail" 
                                    required
                                    placeholder="exemplo@email.com"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="editDataNascimento">Data de Nascimento</label>
                                <input type="date" id="editDataNascimento">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Informa√ß√µes Profissionais</div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editSetor">
                                    Setor <span class="required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="editSetor" 
                                    required
                                    placeholder="Ex: Produ√ß√£o, RH, TI..."
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="editTempoExperiencia">Tempo de Experi√™ncia</label>
                                <input 
                                    type="text" 
                                    id="editTempoExperiencia" 
                                    placeholder="Ex: 2 anos e 6 meses"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="editMatricula">Matr√≠cula</label>
                                <input 
                                    type="text" 
                                    id="editMatricula" 
                                    placeholder="Ex: 2025001"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="editTurma">Turma</label>
                                <select id="editTurma">
                                    <option value="">‚è≥ Carregando turmas...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Senha</div>
                        
                        <div class="senha-box">
                            <strong>üîë Senha Tempor√°ria:</strong>
                            <p class="senha-valor" id="senhaAtual">-</p>
                            <small>
                                ‚ö†Ô∏è Esta √© a senha original gerada no cadastro. Use "Resetar Senha" para enviar um email de redefini√ß√£o ao aluno.
                            </small>
                        </div>
                    </div>
                    
                    <!-- Bot√µes de a√ß√£o -->
                    <div class="acoes">
                        <button type="submit" class="btn-action btn-salvar">
                            üíæ Salvar Altera√ß√µes
                        </button>
                        <button type="button" class="btn-action btn-resetar" onclick="resetarSenha()">
                            üîÑ Resetar Senha (Email)
                        </button>
                        <button type="button" class="btn-action btn-copiar" onclick="copiarCredenciais()">
                            üìã Copiar Credenciais
                        </button>
                        <button type="button" class="btn-action" id="btnStatus" onclick="toggleStatus()">
                            üîí Desativar Aluno
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <script type="module">
        import { getAuth, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        import { db } from "./JS/firebase.js";
        import { 
            doc, 
            updateDoc, 
            query, 
            collection, 
            where, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
        import { buscarTurmas } from "./JS/api-service.js";

        let alunoAtual = null;
        let fotoBase64 = null;
        const auth = getAuth();

        // Carregar turmas ao iniciar
        async function carregarTurmas() {
            try {
                const result = await buscarTurmas({ ativa: true });
                const select = document.getElementById('editTurma');
                
                if (result.success && result.data.length > 0) {
                    select.innerHTML = '<option value="">Nenhuma turma</option>' +
                        result.data.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');
                } else {
                    select.innerHTML = '<option value="">Nenhuma turma dispon√≠vel</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
                document.getElementById('editTurma').innerHTML = '<option value="">Erro ao carregar turmas</option>';
            }
        }

        carregarTurmas();

        // Buscar aluno
        window.buscarAluno = async function() {
            const email = document.getElementById('emailBusca').value.trim().toLowerCase();
            
            if (!email) {
                alert('‚ùå Por favor, digite um email');
                return;
            }

            const loading = document.getElementById('loading');
            const resultado = document.getElementById('resultado');
            
            loading.classList.add('show');
            resultado.classList.remove('show');

            try {
                const q = query(
                    collection(db, "usuarios"),
                    where("email", "==", email),
                    where("role", "==", "aluno")
                );
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    alert('‚ùå Aluno n√£o encontrado com este email');
                    loading.classList.remove('show');
                    return;
                }

                const alunoDoc = snapshot.docs[0];
                alunoAtual = { id: alunoDoc.id, ...alunoDoc.data() };

                // Preencher formul√°rio
                preencherFormulario(alunoAtual);

                loading.classList.remove('show');
                resultado.classList.add('show');

                // Scroll suave at√© o resultado
                resultado.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error('Erro ao buscar:', error);
                alert('‚ùå Erro ao buscar aluno: ' + error.message);
                loading.classList.remove('show');
            }
        };

        // Preencher formul√°rio com dados do aluno
        function preencherFormulario(aluno) {
            document.getElementById('alunoNomeDisplay').textContent = aluno.nome;
            document.getElementById('alunoEmailDisplay').textContent = aluno.email;
            document.getElementById('alunoIdDisplay').textContent = aluno.id;
            
            document.getElementById('editNome').value = aluno.nome || '';
            document.getElementById('editNomeExibicao').value = aluno.nomeExibicao || aluno.nome || '';
            document.getElementById('editEmail').value = aluno.email || '';
            document.getElementById('editDataNascimento').value = aluno.dataNascimento || '';
            document.getElementById('editSetor').value = aluno.setor || '';
            document.getElementById('editTempoExperiencia').value = aluno.tempoExperiencia || '';
            document.getElementById('editMatricula').value = aluno.matricula || '';
            document.getElementById('editTurma').value = aluno.turmaId || '';
            
            document.getElementById('senhaAtual').textContent = aluno.senhaTemporaria || '(n√£o registrada)';
            
            // Foto
            const fotoUrl = aluno.foto || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            document.getElementById('fotoPreview').src = fotoUrl;
            fotoBase64 = aluno.foto;
            
            // Status
            const badge = document.getElementById('statusBadge');
            const btnStatus = document.getElementById('btnStatus');
            
            if (aluno.ativo !== false) {
                badge.textContent = '‚óè Ativo';
                badge.className = 'badge ativo';
                btnStatus.textContent = 'üîí Desativar Aluno';
                btnStatus.className = 'btn-action btn-desativar';
            } else {
                badge.textContent = '‚óè Inativo';
                badge.className = 'badge inativo';
                btnStatus.textContent = '‚úÖ Ativar Aluno';
                btnStatus.className = 'btn-action btn-ativar';
            }
        }

        // Handle foto change
        window.handleFotoChange = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('‚ùå Por favor, selecione apenas arquivos de imagem');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå Imagem muito grande. Tamanho m√°ximo: 5MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                fotoBase64 = e.target.result;
                document.getElementById('fotoPreview').src = fotoBase64;
            };
            reader.readAsDataURL(file);
        };

        // Salvar altera√ß√µes
        window.salvarAlteracoes = async function(event) {
            event.preventDefault();
            
            if (!alunoAtual) return;

            const emailNovo = document.getElementById('editEmail').value.trim().toLowerCase();
            const emailAntigo = alunoAtual.email;

            if (!confirm('üíæ Confirma salvar todas as altera√ß√µes?')) return;

            try {
                const updates = {
                    nome: document.getElementById('editNome').value.trim(),
                    nomeExibicao: document.getElementById('editNomeExibicao').value.trim(),
                    email: emailNovo,
                    dataNascimento: document.getElementById('editDataNascimento').value || null,
                    setor: document.getElementById('editSetor').value.trim(),
                    tempoExperiencia: document.getElementById('editTempoExperiencia').value.trim(),
                    matricula: document.getElementById('editMatricula').value.trim() || null,
                    turmaId: document.getElementById('editTurma').value || null,
                    foto: fotoBase64
                };

                // Atualizar no Firestore
                await updateDoc(doc(db, "usuarios", alunoAtual.id), updates);

                // Se email mudou, alertar
                if (emailNovo !== emailAntigo) {
                    alert('‚ö†Ô∏è Email alterado!\n\nO aluno precisar√° usar o novo email para login.\n\nConsidere enviar um email de reset de senha para o novo endere√ßo.');
                }

                alert('‚úÖ Altera√ß√µes salvas com sucesso!');
                
                // Atualizar dados locais
                alunoAtual = { ...alunoAtual, ...updates };
                preencherFormulario(alunoAtual);

            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('‚ùå Erro ao salvar altera√ß√µes: ' + error.message);
            }
        };

        // Resetar senha
        window.resetarSenha = async function() {
            if (!alunoAtual) return;

            if (!confirm(`üîÑ Enviar email de reset de senha para ${alunoAtual.email}?`)) return;

            try {
                await sendPasswordResetEmail(auth, alunoAtual.email);
                alert(`‚úÖ Email de reset enviado para ${alunoAtual.email}\n\nO aluno deve verificar a caixa de entrada (e tamb√©m a pasta de spam).`);
            } catch (error) {
                console.error('Erro ao resetar:', error);
                alert('‚ùå Erro ao enviar email de reset: ' + error.message);
            }
        };

        // Copiar credenciais
        window.copiarCredenciais = function() {
            if (!alunoAtual) return;

            const texto = `Email: ${alunoAtual.email}\nSenha: ${alunoAtual.senhaTemporaria || '(n√£o registrada)'}`;
            
            navigator.clipboard.writeText(texto)
                .then(() => alert('‚úÖ Credenciais copiadas para a √°rea de transfer√™ncia!'))
                .catch(() => alert('‚ùå Erro ao copiar. Tente novamente.'));
        };

        // Toggle status (ativar/desativar)
        window.toggleStatus = async function() {
            if (!alunoAtual) return;

            const novoStatus = !(alunoAtual.ativo !== false);
            const acao = novoStatus ? 'ativar' : 'desativar';
            const emoji = novoStatus ? '‚úÖ' : 'üîí';

            if (!confirm(`${emoji} Deseja ${acao} este aluno?`)) return;

            try {
                await updateDoc(doc(db, "usuarios", alunoAtual.id), {
                    ativo: novoStatus
                });

                alert(`‚úÖ Aluno ${acao}do com sucesso!`);
                
                alunoAtual.ativo = novoStatus;
                preencherFormulario(alunoAtual);

            } catch (error) {
                console.error('Erro ao alterar status:', error);
                alert('‚ùå Erro ao alterar status: ' + error.message);
            }
        };
    </script>
</body>
</html>
